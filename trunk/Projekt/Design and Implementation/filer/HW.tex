\chapter{Hardware}
Each unit is described by the following procedure:
\begin{itemize}
\item Overall design and block description - Quick design overview
\item Block breakdown - Detailed design overview
\item Block construction - Detailed implementation, simulation and calculation results.
\end{itemize}
This procedure is meant to ease readability and help give an overview of the entire system implementation.
\section{CDU}
The CDU responsibility is, as described in the previous documents, to control the custom powerline communication and to govern the information about the sensor nodes. The information is stored in memory and can be loaded out to a PC.
\subsection{Overall design}
Below is shown a figure of the overall CDU design.
\subsubsection{Block description}
\textbf{Power Supply}

\subsection{Block breakdown}
This section describes the interfaces and the design of each individual block.\\
Below, in figure \ref{fig:detailedCDU}, is shown a detailed overview of the CDU design. This will be the basis of the block breakdown section.
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{billeder/detailedCDU}
	\caption{Detailed CDU breakdown}
	\label{fig:detailedCDU}
\end{figure}

The following subsection will cover all interfaces and design considerations.
\subsubsection{Power Supply}
tbw


\subsubsection{Sensor Power supply}
tbw


\subsubsection{Sensor communication}
tbw



\subsubsection{µ-Controller}
The microcontroller block is a hybrid hardware and software block. Software can be found in the software chapter.\\

\subsubsection{PC communication}
tbw

\subsubsection{Memory}
tbw

\subsection{Block construction}
This section describes all detailed calculations done to realize the implementation aswell as detailed schematics.\\
\subsubsection{Power Supply}
tbw
%The power supply is in charge of providing the system with 3.3 volts. This supply is for analog parts of the CDU and the µ-controller. The design is shown in figure \ref{fig:cdupowersupply}.
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale=1]{billeder/cdupowersupply}
%\label{fig:cdupowersupply}
%\caption{CDU Power Supply}
%\end{figure}

\subsubsection{Sensor Power supply}
tbw
%\begin{figure}[H]
%\centering
%\includegraphics[scale=1]{billeder/cdusensorpowersupply}
%\label{fig:cdusensorpowersupply}
%\caption{Sensor Power Supply part of the CDU}
%\end{figure}

\subsubsection{Sensor communication}
tbw
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale=1]{billeder/cdusensorsend}
%\label{fig:cdusensorsend}
%\caption{Writing to Sensor node(s)}
%\end{figure}

%\begin{figure}[H]
%\centering
%\includegraphics[width=1\textwidth]{billeder/cdusensorread}
%\label{fig:cdusensorread}
%\caption{Reading from Sensor node(s)}
%\end{figure}



\subsubsection{µ-Controller}
The microcontroller block is a hybrid hardware and software block. Software can be found in the software chapter.\\


\subsubsection{PC communication}
tbw

\subsubsection{Memory}
tbw

\section{Sensor Node}
The sensor node responsibility is, as described in the previous documents, to capture a temperature and support the custom powerline communication protocol. Below is described in detail how each block in the sensor node is implemented and designed.

\subsection{Overall design}
Below is shown a figure of the overall sensor node design.
\begin{figure}[H]
\centering
\includegraphics[width=.9\textwidth]{billeder/sn_overall_design}
\caption{Sensor node overall design}
\end{figure}

\subsubsection{Block description}
\textbf{Power supply:}\\
The power supply is creates a steady 3.3V supply to the system from the powerline communication bus.\\

\textbf{Communication:}\\
The communication block convertes the analog communication signal from the CDU to a digital stream of data and clock to the system and the digital communication from the logic handler to an analog signal on the bus to the CDU.\\

\textbf{Logic handler:}\\
The logic handler serves to analyse the incoming data transmission and act accordingly, at the current state this is to either respond with information about the sensor or respond with measured data.\\

\textbf{Sensor:}\\
The sensor part of the sensor node serves as the actual measurement circuit. This has a logical interface to the logic handler.\\

\subsection{Block breakdown}
This section describes the interfaces and the design of each individual block.\\
Below, in figure \ref{fig:SN_detailed}, is shown a detailed overview of the sensor node design. This will be the basis of the block breakdown section.

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{billeder/SN_detailed_design}
	\caption{Detailed sensor node breakdown}
	\label{fig:SN_detailed}
\end{figure}

The following subsection will cover all interfaces and design considerations.

\subsubsection{Powersupply}
The power supply block is responsible for power to the entire sensor. This involves making 3.3V to the system in the sensor node and thereby making a reference voltage as ground to the system. Below in figure \ref{fig:SN_PS_FIGURE} is shown the power supply block.

\begin{figure}[H]
	\centering
	\includegraphics[width=.5\textwidth]{billeder/powersupply_detailed_sn}
	\caption{Sensor node power supply block}
	\label{fig:SN_PS_FIGURE}
\end{figure} 

The goal is to create a steady 3.3V power to the components on the sensor node. The bus is specified as a line where all sensor nodes are placed in series. Therefore each sensor node has an individual reference ground. The line is a constant current modulated with communication.\\
Interfaces:
\begin{table}[H]
	\centering
	\begin{tabular}{|p{3cm} | p{8cm}| }
		\hline
		Interface name: 	& Description: \\ \hline
		S+ 					& The S+ input is the positive connection from the CDU. \\ \hline
		3.3V				& This is the 3.3V supply voltage to the descrete components on the sensor node. \\ 	\hline
		Analog CDU com  	& The voltage drop caused by the communication current over the communication resistor (R$_{\text{com}}$).\\ \hline
		GND					& Voltage reference ground on the individual sensor.\\\hline 
	\end{tabular}
	\caption{Sensor node power supply block interface descriptions}
\end{table}

The S+ and S- signals are from the powerline bus where S+ is connected to the previous sensor or the CDU B+ pin. The S- is connected to the next sensor or the CDU B- pin.\\

The diode and R$_{\text{com}}$ creates a voltage drop from which the voltage regulator creates the steady 3.3V supply. The R$_{\text{com}}$ resistor serves to "convert" the current modulated communication to a voltage to the communication block.

\subsubsection{Communication}

The purpose of the communication block is to synchronize the sensor node clock to the CDU clock to make sure the data is sampled properly.

\begin{figure}[H]
	\centering
	\includegraphics[width=.5\textwidth]{billeder/communication_sn}
	\caption{Sensor node communication block}
	\label{fig:SN_com_fig}
\end{figure}

The communication block generates a steady synchronized clock and converts data to the correct logic levels. It also has a logical interface which enables responds to the CDU by modulating the voltage drop over the entire sensor. In figure \ref{fig:SN_com_fig} the communication block is shown.

\begin{table}[H]
	\centering
	\begin{tabular}{|p{3cm} | p{8cm}| }
		\hline
		Interface name: & Description: \\ \hline
		Supply			& 3.3V from the power supply. \\ \hline
		Analog com in	& The voltage-converted communication signal from the CDU.\\ \hline
		Respond signal  & Digital input with the respond to the CDU from the logic handler. \\ \hline
		GND				& Voltage reference ground on the individual sensor.\\\hline 
	\end{tabular}
	\caption{Sensor node communication block interface descriptions}
\end{table}

The Analog CDU com signal received from the powersupply is converted to the correct logic levels on the sensor node. This is done with an amplifier and a signal reference. The converted signal is now a direct image of the data transmitted from the CDU. The clock recovery circuit is responsible for creating a synchronized clock from this data signal. The respond circuit receives logic levels from the logic handler and generate an analog signal which is received at the CDU.

\subsubsection{Logic handler}
The logic handler is the central computational unit and is a programmable logic chip. It serves to interpret incoming messages and act accordingly whilst also interfacing with the ADC to acquire new data to be sent to the CDU. In figure \ref{fig:sn_logic_handler} the logic handler block is shown.

\begin{figure}[H]
	\centering
	\includegraphics[width=.5\textwidth]{billeder/logic_handler_sn}
	\caption{Sensor node logic handler block}
	\label{fig:sn_logic_handler}
\end{figure}

\begin{table}[H]
	\centering
	\begin{tabular}{|p{3cm} |p{3cm} | p{8cm}| }
		\hline
		Interface name: 			& Direction: 	& Description: \\ \hline
		Supply						& NA			& 3.3V from the power supply. \\ \hline
		GND							& NA			& The voltage-converted communication signal from the CDU.\\ \hline
		Respond		  				& Output		& Digital respond signal to the respond circuit in the communication block. \\ \hline
		Clock						& Input			& 20kHz synchronized clock from the communication block.\\\hline 
		Data						& Input			& Digital data from the communication block.\\\hline
		SCK							& Output		& Serial clock to the SPI interface to the Data acquisition block.\\\hline
		DIN							& Input			& Data received from the Data acquisition block.\\\hline
		$\overline{\text{CS}}$		& Output		& Active low chip select to the Data acquisition block.\\\hline
		$\overline{\text{SHDN}}$	& Output		& Active low shutdown input on the Data acquisition block.\\\hline
	\end{tabular}
	\caption{Sensor node logic handler block interface descriptions}
\end{table}


\subsubsection{Sensor}

\subsection{Block construction}
This section describes all detailed calculations done to realize the implementation aswell as detailed schematics.\\

\subsubsection{Powersupply}
As seen on figure \ref{fig:SN_detailed_ps} the powersupply consists of a zener diode, a sense resistor and a voltage regulator.\\
The voltage regulator should output a 3.3V to supply the sensor. Below on figure \ref{fig:LM317} is shown a typical application from the datasheet. The to this application the following formula for output voltage is given:\\
\begin{equation}
	V_{out}=1.25V\left(1+\frac{R2}{R1}\right)+ I_{ADJ}*R2
\end{equation}

With R1 given as 240$\Omega$, V$_{OUT}$=3.3V and I$_{ADJ}$=50$\mu$A(typ.) R2 will be $\approx$ 390$\Omega$.


\begin{figure}[H]
	\centering
	\includegraphics[width=.5\textwidth]{billeder/LM317}
	\caption{LM117 voltage regulator series typical application}
	\label{fig:LM317}
\end{figure}

In the datasheet the input voltage versus output voltage is specified to a minimum of 3V to ensure the specified output current of 100mA. But since we doesn't need more then 20mA at max we tested the regulator with $V_{IN}-V_{OUT}=1.3V$ and the output voltage is well within acceptable levels.\\

\textbf{Simulation result:}\\

\begin{figure}[H]
	\centering
	\includegraphics[width=.5\textwidth]{billeder/PS_lm317_sim}
	\caption{Powersupply simulation}
	\label{fig:ps_sim}
\end{figure}



\subsubsection{Communication}

\subsubsection{Logic handler}

\subsubsection{Sensor}








